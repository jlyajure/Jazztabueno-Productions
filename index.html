<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <title>Jazztabueno Radio</title>
    <meta name="apple-mobile-web-app-title" content="Jazztabueno">
    <meta name="application-name" content="Jazztabueno">
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/192/saxophone.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/saxophone.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; }
        :root { 
            --gold: #d4af37; 
            --dark-gold: #aa8c2c;
            --bg-color: #050505; 
            --card-bg: #111111;
            --text-main: #e2e8f0;
        }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            min-height: 100vh; 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%); 
            background-attachment: fixed; 
            color: var(--text-main); 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        h1, h2, .program-tag { font-family: 'Playfair Display', serif; }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://images.unsplash.com/photo-1511192336575-5a79af67a629?auto=format&fit=crop&q=80&w=1932') no-repeat center center/cover; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #login-screen::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .login-card { position: relative; background: rgba(20, 20, 20, 0.95); border: 1px solid var(--gold); padding: 40px 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); }
        #passInput { width: 100%; padding: 15px; border: 1px solid #333; border-bottom: 2px solid var(--gold); background: transparent; color: white; text-align: center; outline: none; margin-top: 20px; font-size: 18px; font-family: 'Playfair Display', serif; }
        
        #app-content { display: none; padding-bottom: 80px; }
        
        header { 
            background: rgba(5, 5, 5, 0.95); 
            padding: 15px 20px; 
            position: sticky; top: 0; z-index: 100; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #222; 
        }
        .brand-title { color: var(--gold); font-size: 20px; font-weight: 700; margin: 0; letter-spacing: 1px; }

        /* NUEVO ESTILO PARA EL BOT√ìN SALIR */
        .btn-logout {
            background: transparent;
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .container { max-width: 500px; margin: auto; padding: 20px 15px; }

        /* SCROLL MEJORADO */
        .filter-scroll { 
            display: flex;
            gap: 10px;
            overflow-x: auto; 
            white-space: nowrap; 
            padding-bottom: 15px; 
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; 
        }
        .filter-scroll::-webkit-scrollbar { display: none; }

        .filter-btn { 
            flex: 0 0 auto; 
            background: #222; 
            border: 1px solid #444; 
            color: #888; 
            padding: 10px 20px; 
            border-radius: 30px; 
            font-size: 13px; 
            cursor: pointer; 
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .filter-btn.active { 
            background: var(--gold); 
            color: black; 
            border-color: var(--gold); 
            font-weight: 800; 
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
        }

        .upload-section { background: #1a1a1a; border: 1px dashed var(--gold); padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center; display: none; }
        .input-dark { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; background: #000; border: 1px solid #333; color: white; }
        .btn-gold { background: var(--gold); color: black; padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; text-transform: uppercase; }
        .btn-toggle-upload { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 10px; width: 100%; border-radius: 8px; margin-bottom: 20px; cursor: pointer; }

        .episode-card { 
            background: var(--card-bg); 
            border-radius: 15px; 
            margin-bottom: 25px; 
            overflow: hidden; 
            border: 1px solid #222;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        
        .cover-art {
            height: 180px;
            width: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .play-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .play-icon { font-size: 50px; color: rgba(255,255,255,0.8); }

        .episode-info { padding: 20px; }
        
        .program-tag { 
            display: inline-block; 
            font-size: 10px; 
            color: black; 
            padding: 4px 10px; 
            border-radius: 4px; 
            font-weight: bold; 
            text-transform: uppercase; 
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .tag-jazz { background: var(--gold); }
        .tag-studio { background: #3b82f6; color: white; }
        .tag-salsa { background: #ef4444; color: white; }
        .tag-old { background: #a8a29e; color: black; }

        .episode-title { font-size: 18px; margin: 0 0 5px 0; color: white; }
        .episode-date { font-size: 12px; color: #666; display: block; margin-bottom: 15px; }

        audio {
            width: 100%;
            height: 40px;
            margin-top: 10px;
            filter: invert(100%); 
            border-radius: 20px;
        }

        .btn-delete { float: right; background: transparent; border: none; color: #ef4444; font-size: 20px; cursor: pointer; margin-top: -5px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <div style="font-size: 50px; margin-bottom: 10px;">üé∑</div>
        <h2 style="color: var(--gold); margin: 0;">Jazztabueno<br>Productions</h2>
        <p style="color: #888; font-size: 12px; margin-top: 10px;">Acceso Privado</p>
        <input type="password" id="passInput" placeholder="Clave de Producci√≥n">
    </div>
</div>

<div id="app-content">
    <header>
        <div class="brand-title">JAZZTABUENO</div>
        <button class="btn-logout" onclick="salirDeApp()">SALIR üîí</button>
    </header>
    
    <div class="container">
        
        <button class="btn-toggle-upload" onclick="toggleUpload()">üì° SUBIR NUEVO PROGRAMA</button>
        
        <div id="upload-section" class="upload-section">
            <h3 style="color:var(--gold); margin-top:0;">Nuevo Programa</h3>
            
            <select id="progInput" class="input-dark">
                <option value="JAZZTABUENO">üé∑ JAZZTABUENO</option>
                <option value="STUDIO79">üéß STUDIO 79</option>
                <option value="SALSA BRAVA">üî• SALSA BRAVA</option>
                <option value="OLD SCHOOL">üìª OLD SCHOOL RADIO</option>
            </select>
            
            <input type="text" id="titleInput" class="input-dark" placeholder="T√≠tulo (Ej: Especial Fania All Stars)">
            <input type="text" id="linkInput" class="input-dark" placeholder="Pegar Link MP3 de Archive.org...">
            
            <button class="btn-gold" onclick="publicarEpisodio()">LANZAR AL AIRE</button>
            <p id="status-msg" style="font-size:12px; color:#888; margin-top:10px;"></p>
        </div>

        <div class="filter-scroll">
            <button class="filter-btn active" onclick="filtrar('Todo')">Todo</button>
            <button class="filter-btn" onclick="filtrar('JAZZTABUENO')">üé∑ JAZZTABUENO</button>
            <button class="filter-btn" onclick="filtrar('STUDIO79')">üéß STUDIO 79</button>
            <button class="filter-btn" onclick="filtrar('SALSA BRAVA')">üî• SALSA BRAVA</button>
            <button class="filter-btn" onclick="filtrar('OLD SCHOOL')">üìª OLD SCHOOL</button>
        </div>

        <div id="radio-feed"></div>
    </div>
</div>

<script type="module">
    import { db } from "./firebase.js";
    import { collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const CLAVE_ACCESO = "jazz2026";
    const CLAVE_ADMIN = "ticoadmin"; 

    let todosLosEpisodios = [];
    let filtroActual = 'Todo';

    const CARATULAS = {
        'JAZZTABUENO': 'https://images.unsplash.com/photo-1511192336575-5a79af67a629?auto=format&fit=crop&q=80&w=800',
        'STUDIO79': 'https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?auto=format&fit=crop&q=80&w=800',
        'SALSA BRAVA': 'https://images.unsplash.com/photo-1516280440614-6697288d5d38?auto=format&fit=crop&q=80&w=800',
        'OLD SCHOOL': 'https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?auto=format&fit=crop&q=80&w=800'
    };

    const checkAuth = () => {
        if(localStorage.getItem('jazz_auth')) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
        }
    };
    checkAuth();

    document.getElementById('passInput').oninput = (e) => {
        const val = e.target.value;
        if(val === CLAVE_ACCESO || val === CLAVE_ADMIN) {
            localStorage.setItem('jazz_auth', val);
            location.reload();
        }
    };

    // --- FUNCI√ìN DE SALIDA SEGURA ---
    window.salirDeApp = () => {
        if(confirm("¬øCerrar sesi√≥n?")) {
            localStorage.removeItem('jazz_auth');
            location.reload();
        }
    };

    window.toggleUpload = () => {
        const sec = document.getElementById('upload-section');
        sec.style.display = sec.style.display === 'block' ? 'none' : 'block';
    };

    window.publicarEpisodio = async () => {
        const programa = document.getElementById('progInput').value;
        const titulo = document.getElementById('titleInput').value;
        const link = document.getElementById('linkInput').value;
        const status = document.getElementById('status-msg');

        if(!link || !titulo) { alert("Falta el link o el t√≠tulo"); return; }
        
        status.innerHTML = "üì° Conectando...";

        try {
            await addDoc(collection(db, "radio_programas"), {
                programa: programa,
                titulo: titulo,
                mp3Url: link, 
                fecha: new Date()
            });

            status.innerHTML = "‚úÖ ¬°En el aire!";
            document.getElementById('linkInput').value = "";
            document.getElementById('titleInput').value = "";
            setTimeout(() => { document.getElementById('upload-section').style.display = 'none'; status.innerHTML = ""; }, 2000);

        } catch (e) {
            alert("Error: " + e.message);
        }
    };

    window.filtrar = (cat) => {
        filtroActual = cat;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.innerText.includes(cat) || (cat === 'Todo' && btn.innerText === 'Todo')) btn.classList.add('active');
        });
        pintarRadio();
    };

    const q = query(collection(db, "radio_programas"), orderBy("fecha", "desc"));
    onSnapshot(q, (snapshot) => {
        todosLosEpisodios = [];
        snapshot.forEach((doc) => {
            todosLosEpisodios.push({ id: doc.id, ...doc.data() });
        });
        pintarRadio();
    });

    function pintarRadio() {
        const feed = document.getElementById('radio-feed');
        feed.innerHTML = "";
        const isAdmin = localStorage.getItem('jazz_auth') === CLAVE_ADMIN;

        const lista = todosLosEpisodios.filter(ep => filtroActual === 'Todo' || ep.programa.includes(filtroActual) || filtroActual.includes(ep.programa));

        if(lista.length === 0) {
            feed.innerHTML = `<div style="text-align:center; padding:40px; color:#444;">Sin transmisi√≥n en esta frecuencia... üìª</div>`;
            return;
        }

        lista.forEach(ep => {
            let tagClass = "tag-jazz";
            let imagenFondo = CARATULAS['JAZZTABUENO'];

            if(ep.programa.includes("STUDIO")) { tagClass = "tag-studio"; imagenFondo = CARATULAS['STUDIO79']; }
            if(ep.programa.includes("SALSA")) { tagClass = "tag-salsa"; imagenFondo = CARATULAS['SALSA BRAVA']; }
            if(ep.programa.includes("OLD")) { tagClass = "tag-old"; imagenFondo = CARATULAS['OLD SCHOOL']; }

            const fecha = ep.fecha ? ep.fecha.toDate().toLocaleDateString() : "";

            feed.innerHTML += `
                <div class="episode-card">
                    <div class="cover-art" style="background-image: url('${imagenFondo}');">
                        <div class="play-overlay">
                            <span class="play-icon">‚ñ∂</span>
                        </div>
                    </div>
                    
                    <div class="episode-info">
                        <span class="program-tag ${tagClass}">${ep.programa}</span>
                        ${isAdmin ? `<button class="btn-delete" onclick="borrarEpisodio('${ep.id}')">üóëÔ∏è</button>` : ''}
                        
                        <h3 class="episode-title">${ep.titulo}</h3>
                        <span class="episode-date">Publicado: ${fecha}</span>
                        
                        <audio controls>
                            <source src="${ep.mp3Url}" type="audio/mpeg">
                            Tu navegador no soporta audio.
                        </audio>
                    </div>
                </div>
            `;
        });
    }

    window.borrarEpisodio = async (id) => {
        if(confirm("¬øEliminar este episodio del aire?")) {
            await deleteDoc(doc(db, "radio_programas", id));
        }
    };
</script>

</body>
</html>
